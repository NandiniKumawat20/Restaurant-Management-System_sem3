<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Restaurant Management System</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root{
      --bg:#071022;
      --card:#0b1220;
      --muted:#9aa4b2;
      --accent:#ff6b35;
      --radius:12px;
      font-family: Inter, Arial, sans-serif;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      background:linear-gradient(180deg,#071022 0%,#081627 100%);
      color:#e6eef6;
    }

    .container{
      width:95%;
      max-width:980px;
      background:var(--card);
      border-radius:var(--radius);
      padding:20px;
      box-shadow:0 10px 30px rgba(0,0,0,0.6);
    }

    h1,h2,h3{color:var(--accent); margin:6px 0 16px; text-align:center;}
    .top-row{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;}
    .flex{display:flex;gap:12px;align-items:center;}
    .left, .right{flex:1}

    /* login/register */
    .panel { background:#071326; padding:16px; border-radius:10px; max-width:480px; margin:0 auto; }
    label{display:block;color:var(--muted); font-size:13px; margin-bottom:6px}
    input, select, textarea, button { width:100%; padding:10px; border-radius:8px; border:1px solid rgba(255,255,255,0.06); background:transparent; color:#fff }
    textarea{min-height:80px; resize:vertical}
    .btn{background:var(--accent); border:none; color:#fff; cursor:pointer; font-weight:700}
    .btn.secondary{background:#374151}
    .small{padding:8px;font-size:14px}

    /* dashboards */
    .dash-grid{display:flex; gap:18px; flex-wrap:wrap;}
    .menu-bar{display:flex; gap:12px; justify-content:center; flex-wrap:wrap; margin-bottom:14px}
    .menu-item{background:#0f1a2b;padding:10px 14px;border-radius:10px;cursor:pointer;text-align:center;width:140px}
    .menu-item .icon{font-size:44px;color:var(--accent);display:block;margin:0 auto 8px;}
    .content{background:#071a2b;padding:14px;border-radius:10px; color:#e6eef6}

    table{width:100%;border-collapse:collapse;margin-top:10px}
    th, td{padding:10px;border-bottom:1px solid rgba(255,255,255,0.03); text-align:left}
    th{color:var(--accent)}

    .list-rest { display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:12px; }
    .rest-card { background:#0f1a2b;padding:10px;border-radius:10px; display:flex; gap:10px; align-items:center; cursor:pointer; }
    .rest-card img { width:64px;height:64px;border-radius:8px; object-fit:cover }
    .right-col { text-align:right; }

    /* Zomato-style dish cards (user view) */
    .dish-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:12px; margin-top:12px; }
    .dish-card { background:#0f1a2b; border-radius:10px; overflow:hidden; display:flex; flex-direction:column; }
    .dish-card img { width:100%; height:140px; object-fit:cover; display:block; }
    .dish-card .info { padding:10px; display:flex; flex-direction:column; gap:6px; }
    .dish-name { font-weight:700; }
    .dish-meta { color:var(--muted); font-size:13px; display:flex; justify-content:space-between; align-items:center; }
    .order-count { font-size:12px; color: #cbd5e1; }

    .back { margin-top:14px; background:#374151; }
    @media (max-width:700px){ .menu-item{width:110px} .rest-card{flex-direction:column; align-items:flex-start} .right-col{ text-align:left } }
  </style>
</head>
<body>
  <div class="container" id="app">

    <!-- top header -->
    <div class="top-row">
      <div><h1>Spice & Flavor — Demo</h1></div>
      <div id="top-actions" class="flex"></div>
    </div>

    <!-- LOGIN / REGISTER -->
    <div id="auth-area" class="panel">
      <div id="login-view">
        <h2>Login</h2>
        <label>Email</label><input id="login-email" placeholder="you@example.com">
        <label>Password</label><input id="login-password" type="password" placeholder="password">
        <div style="display:flex;gap:10px;margin-top:10px">
          <button class="btn" id="login-btn">Login</button>
          <button class="btn secondary" id="show-register">Register</button>
        </div>
        <p style="color:var(--muted); margin-top:10px; font-size:13px">Registering a restaurant will allow management features. Registering as a user will allow browsing restaurants.</p>
      </div>

      <div id="register-view" style="display:none;">
        <h2>Register</h2>
        <label>Account Type</label>
        <select id="reg-type">
          <option value="user">User</option>
          <option value="restaurant">Restaurant</option>
        </select>
        <label>Name</label><input id="reg-name" placeholder="Your name / Restaurant name">
        <label>Email</label><input id="reg-email" placeholder="you@example.com">
        <label>Password</label><input id="reg-password" type="password">
        <label>Confirm Password</label><input id="reg-confirm" type="password">
        <div style="display:flex;gap:10px;margin-top:10px">
          <button class="btn" id="register-btn">Register</button>
          <button class="btn secondary" id="show-login">Back to Login</button>
        </div>
      </div>
    </div>

    <!-- RESTAURANT DASHBOARD (for restaurant accounts) -->
    <div id="restaurant-dashboard" style="display:none">
      <div class="top-row">
        <div><h2 id="rest-title">Restaurant Dashboard</h2></div>
        <div class="right-col">
          <button class="btn small" id="rest-home-btn">Dashboard Home</button>
          <button class="btn small secondary" id="rest-logout">Logout</button>
        </div>
      </div>

      <div class="menu-bar" id="rest-menu">
        <div class="menu-item" data-sec="manage-menu"><img src="https://cdn-icons-png.flaticon.com/512/2921/2921820.png"><div>Menu</div></div>
        <div class="menu-item" data-sec="manage-tables"><img src="https://cdn-icons-png.flaticon.com/512/1046/1046784.png"><div>Tables</div></div>
        <div class="menu-item" data-sec="manage-income"><img src="https://cdn-icons-png.flaticon.com/512/1170/1170678.png"><div>Income</div></div>
        <div class="menu-item" data-sec="manage-feedback"><img src="https://cdn-icons-png.flaticon.com/512/2462/2462719.png"><div>Feedback</div></div>
        <div class="menu-item" data-sec="manage-orders"><img src="https://cdn-icons-png.flaticon.com/512/2830/2830308.png"><div>Orders</div></div>
      </div>

      <div class="content" id="rest-content">
        <h3>Welcome — manage your restaurant from here</h3>
        <p style="color:var(--muted)">Choose one of the tiles above to add menu items, tables, view income and customer feedback.</p>
      </div>
    </div>

    <!-- USER DASHBOARD -->
    <div id="user-dashboard" style="display:none">
      <div class="top-row">
        <div><h2 id="user-title">User Panel</h2></div>
        <div class="right-col">
          <button class="btn small" id="user-home-btn">Home</button>
          <button class="btn small secondary" id="user-logout-btn">Logout</button>
        </div>
      </div>

      <div class="content" id="user-content">
        <h3>Choose a restaurant to visit</h3>
        <div id="restaurant-list" class="list-rest" style="margin-top:12px;"></div>
      </div>
    </div>

  </div>

<script>
/* ======= API and Utility helpers ======= */
const API_BASE = 'http://localhost:3000/api';
const TOKEN_KEY = 'rms_token';

function getToken() { return localStorage.getItem(TOKEN_KEY); }
function setToken(token) { localStorage.setItem(TOKEN_KEY, token); }
function removeToken() { localStorage.removeItem(TOKEN_KEY); }

async function apiRequest(endpoint, options = {}) {
  const url = `${API_BASE}${endpoint}`;
  const token = getToken();
  const headers = { 'Content-Type': 'application/json', ...options.headers };
  if (token) headers['Authorization'] = `Bearer ${token}`;

  try {
    const response = await fetch(url, { ...options, headers });
    const data = await response.json();
    if (!response.ok) {
      // Handle different error formats
      let errorMessage = 'API error';
      if (data.message) {
        errorMessage = data.message;
      } else if (data.errors && Array.isArray(data.errors)) {
        errorMessage = data.errors.map(err => err.msg || err.message).join(', ');
      } else if (data.error) {
        errorMessage = data.error;
      }
      throw new Error(errorMessage);
    }
    return data;
  } catch (error) {
    console.error('API Error:', error);
    alert('Error: ' + error.message);
    throw error;
  }
}

function uid(prefix='id'){ return prefix + '_' + Math.random().toString(36).slice(2,9); }

async function loadRestaurantsFromAPI() {
  try {
    restaurants = await apiRequest('/restaurants');
  } catch (error) {
    restaurants = [];
  }
}

/* ======= App state ======= */
let restaurants = []; // will be loaded from API
let currentAccount = null;          // account object when logged in
let currentRestaurantId = null;     // when user visits a restaurant

/* ======= DOM refs ======= */
const authArea = document.getElementById('auth-area');
const loginView = document.getElementById('login-view');
const registerView = document.getElementById('register-view');

const restaurantDashboard = document.getElementById('restaurant-dashboard');
const restContent = document.getElementById('rest-content');
const restTitle = document.getElementById('rest-title');

const userDashboard = document.getElementById('user-dashboard');
const userContent = document.getElementById('user-content');
const restaurantListEl = document.getElementById('restaurant-list');

/* ======= Auth UI handlers ======= */
document.getElementById('show-register').addEventListener('click', e=>{
  e.preventDefault();
  loginView.style.display='none';
  registerView.style.display='block';
});
document.getElementById('show-login').addEventListener('click', e=>{
  e.preventDefault();
  registerView.style.display='none';
  loginView.style.display='block';
});

/* Registration: creates either user account or restaurant entry + account */
document.getElementById('register-btn').addEventListener('click', async ()=>{
  const type = document.getElementById('reg-type').value;
  const name = document.getElementById('reg-name').value.trim();
  const email = document.getElementById('reg-email').value.trim().toLowerCase();
  const pass = document.getElementById('reg-password').value;
  const confirm = document.getElementById('reg-confirm').value;

  if(!name || !email || !pass || !confirm){ alert('Fill all fields'); return; }
  if(pass !== confirm){ alert('Passwords do not match'); return; }

  try {
    const data = await apiRequest('/auth/register', {
      method: 'POST',
      body: JSON.stringify({ email, password: pass, name, type })
    });
    alert(`${type === 'restaurant' ? 'Restaurant' : 'User'} registered successfully. You can now login.`);
    registerView.style.display='none';
    loginView.style.display='block';
  } catch (error) {
    // error already alerted
  }
});

/* Login handler */
document.getElementById('login-btn').addEventListener('click', async ()=>{
  const email = document.getElementById('login-email').value.trim().toLowerCase();
  const pass = document.getElementById('login-password').value;
  if(!email || !pass){ alert('Enter credentials'); return; }

  try {
    const data = await apiRequest('/auth/login', {
      method: 'POST',
      body: JSON.stringify({ email, password: pass })
    });
    setToken(data.token);
    currentAccount = data.user;

    // show appropriate dashboard
    authArea.style.display = 'none';
    if(currentAccount.type === 'restaurant'){
      await loadRestaurantDashboard(currentAccount.restaurantId);
      restaurantDashboard.style.display = 'block';
      restTitle.textContent = currentAccount.name;
    } else {
      // user: show list of restaurants
      await showRestaurantSelection();
      userDashboard.style.display = 'block';
      document.getElementById('user-title').textContent = `Welcome, ${currentAccount.name}`;
    }
  } catch (error) {
    // error already alerted
  }
});

/* Logout buttons */
document.getElementById('rest-logout').addEventListener('click', ()=>{
  currentAccount = null;
  removeToken();
  restaurantDashboard.style.display = 'none';
  authArea.style.display = 'block';
});
document.getElementById('user-logout-btn').addEventListener('click', ()=>{
  currentAccount = null;
  removeToken();
  userDashboard.style.display = 'none';
  authArea.style.display = 'block';
});

/* Dashboard home buttons */
document.getElementById('rest-home-btn').addEventListener('click', ()=>{
  restContent.innerHTML = `<h3>Welcome — manage your restaurant</h3><p style="color:var(--muted)">Choose a tile above to manage menu, tables, income and view feedback.</p>`;
});
document.getElementById('user-home-btn').addEventListener('click', ()=>{
  showRestaurantSelection();
});

/* ======= Restaurant dashboard actions (restaurant account) ======= */
document.querySelectorAll('#rest-menu .menu-item').forEach(item=>{
  item.addEventListener('click', ()=>{
    const sec = item.getAttribute('data-sec');
    if(sec === 'manage-menu') showManageMenu();
    if(sec === 'manage-tables') showManageTables();
    if(sec === 'manage-income') showManageIncome();
    if(sec === 'manage-feedback') showManageFeedback();
    if(sec === 'manage-orders') showManageOrders();
  });
});

/* Load restaurant dashboard data for current restaurant */
async function loadRestaurantDashboard(restaurantId){
  try {
    const rest = await apiRequest(`/restaurants/${restaurantId}`);
    restContent.innerHTML = `<h3>Welcome — manage your restaurant</h3><p style="color:var(--muted)">Choose a tile above to add menu items, tables, income and see feedback.</p>`;
  } catch (error) {
    restContent.innerHTML = `<p style="color:var(--muted)">Failed to load restaurant data.</p>`;
  }
}

/* Manage Menu */
async function showManageMenu(){
  try {
    const rest = await apiRequest(`/restaurants/${currentAccount.restaurantId}`);
    const menu = await apiRequest(`/restaurants/${currentAccount.restaurantId}/menu`);

    restContent.innerHTML = `
      <h3>Menu — ${rest.name}</h3>
      <label>Dish name</label><input id="dish-name" placeholder="e.g., Masala Dosa">
      <label>Price (₹)</label><input id="dish-price" type="number" placeholder="120">
      <label>Image URL (optional)</label><input id="dish-img" placeholder="https://...">
      <div style="display:flex;gap:8px;margin-top:10px">
        <button class="btn" id="add-dish-btn">Add Dish</button>
        <button class="btn secondary back" id="menu-back">Back</button>
      </div>
      <table>
        <thead><tr><th>Dish</th><th>Price</th><th>Orders</th><th>Image</th></tr></thead>
        <tbody id="menu-table">${menu.map(m=>`<tr><td>${m.name}</td><td>₹${m.price}</td><td>${m.orderCount||0}</td><td><img src="${m.img||'https://via.placeholder.com/80'}" style="width:80px;height:50px;object-fit:cover;border-radius:6px"></td></tr>`).join('')}</tbody>
      </table>
    `;

    document.getElementById('add-dish-btn').addEventListener('click', async ()=>{
      const name = document.getElementById('dish-name').value.trim();
      const price = document.getElementById('dish-price').value.trim();
      const img = document.getElementById('dish-img').value.trim() || '';
      if(!name || !price) return alert('Enter name and price');
      try {
        await apiRequest(`/restaurants/${currentAccount.restaurantId}/menu`, {
          method: 'POST',
          body: JSON.stringify({ name, price: Number(price), img })
        });
        showManageMenu();
      } catch (error) {
        // error already alerted
      }
    });

    document.getElementById('menu-back').addEventListener('click', ()=>{
      restContent.innerHTML = `<h3>Welcome — manage your restaurant</h3><p style="color:var(--muted)">Choose a tile above to add menu items, tables, income and see feedback.</p>`;
    });
  } catch (error) {
    alert('Failed to load menu');
  }
}

/* Manage Tables */
async function showManageTables(){
  try {
    const rest = await apiRequest(`/restaurants/${currentAccount.restaurantId}`);
    const tables = await apiRequest(`/restaurants/${currentAccount.restaurantId}/tables`);

    restContent.innerHTML = `
      <h3>Tables — ${rest.name}</h3>
      <label>Table number</label><input id="table-num" placeholder="e.g., 1">
      <label>Status</label>
      <select id="table-status"><option>Available</option><option>Booked</option><option>Occupied</option></select>
      <div style="display:flex;gap:8px;margin-top:10px">
        <button class="btn" id="add-table-btn">Add Table</button>
        <button class="btn secondary back" id="tables-back">Back</button>
      </div>
      <table>
        <thead><tr><th>Image</th><th>Table</th><th>Status</th></tr></thead>
        <tbody id="tables-list">${tables.map(t=>`<tr><td><img src="https://cdn-icons-png.flaticon.com/512/1046/1046784.png" style="width:40px;height:40px;border-radius:6px;"></td><td>${t.num}</td><td>${t.status}</td></tr>`).join('')}</tbody>
      </table>
    `;

    document.getElementById('add-table-btn').addEventListener('click', async ()=>{
      const num = document.getElementById('table-num').value.trim();
      const status = document.getElementById('table-status').value;
      if(!num) return alert('Enter table number');
      try {
        await apiRequest(`/restaurants/${currentAccount.restaurantId}/tables`, {
          method: 'POST',
          body: JSON.stringify({ num, status })
        });
        showManageTables();
      } catch (error) {
        // error already alerted
      }
    });

    document.getElementById('tables-back').addEventListener('click', ()=>{
      restContent.innerHTML = `<h3>Welcome — manage your restaurant</h3><p style="color:var(--muted)">Choose a tile above to add menu items, tables, income and see feedback.</p>`;
    });
  } catch (error) {
    alert('Failed to load tables');
  }
}

/* Manage Income */
async function showManageIncome(){
  try {
    const rest = await apiRequest(`/restaurants/${currentAccount.restaurantId}`);
    const incomes = await apiRequest(`/restaurants/${currentAccount.restaurantId}/incomes`);

    const total = incomes.reduce((a,b)=>a+b.amount,0);
    restContent.innerHTML = `
      <h3>Income — ${rest.name}</h3>
      <label>Amount (₹)</label><input id="income-amt" type="number" placeholder="200">
      <div style="display:flex;gap:8px;margin-top:10px">
        <button class="btn" id="add-income-btn">Add Income</button>
        <button class="btn secondary back" id="income-back">Back</button>
      </div>
      <h4 style="margin-top:12px">Total: ₹${total}</h4>
      <ul>${incomes.map(i=>`<li>₹${i.amount} (${new Date(i.date).toLocaleDateString()})</li>`).join('')}</ul>
    `;

    document.getElementById('add-income-btn').addEventListener('click', async ()=>{
      const amount = Number(document.getElementById('income-amt').value);
      if(isNaN(amount) || amount<=0) return alert('Enter a valid amount');
      try {
        await apiRequest(`/restaurants/${currentAccount.restaurantId}/incomes`, {
          method: 'POST',
          body: JSON.stringify({ amount })
        });
        showManageIncome();
      } catch (error) {
        // error already alerted
      }
    });

    document.getElementById('income-back').addEventListener('click', ()=>{
      restContent.innerHTML = `<h3>Welcome — manage your restaurant</h3><p style="color:var(--muted)">Choose a tile above to add menu items, tables, income and see feedback.</p>`;
    });
  } catch (error) {
    alert('Failed to load income data');
  }
}

/* Manage Feedback */
async function showManageFeedback(){
  try {
    const rest = await apiRequest(`/restaurants/${currentAccount.restaurantId}`);
    const feedback = await apiRequest(`/restaurants/${currentAccount.restaurantId}/feedback`);

    restContent.innerHTML = `
      <h3>Feedback — ${rest.name}</h3>
      <ul>${feedback.map(f=>`<li><strong>${escapeHtml(f.userName)}</strong> (${new Date(f.when).toLocaleString()}): ${escapeHtml(f.text)}</li>`).join('') || '<li>No feedback yet</li>'}</ul>
      <button class="btn secondary back" id="feedback-back">Back</button>
    `;
    document.getElementById('feedback-back').addEventListener('click', ()=> {
      restContent.innerHTML = `<h3>Welcome — manage your restaurant</h3><p style="color:var(--muted)">Choose a tile above to add menu items, tables, income and see feedback.</p>`;
    });
  } catch (error) {
    alert('Failed to load feedback');
  }
}

/* Manage Orders (NEW: shows recorded orders) */
async function showManageOrders(){
  try {
    const rest = await apiRequest(`/restaurants/${currentAccount.restaurantId}`);
    const orders = await apiRequest(`/restaurants/${currentAccount.restaurantId}/orders`);

    restContent.innerHTML = `<h3>Orders — ${rest.name}</h3>`;
    if(!orders || !orders.length){
      restContent.innerHTML += `<p style="color:var(--muted)">No orders yet.</p>`;
      return;
    }

    restContent.innerHTML += `
      <table>
        <thead><tr><th>Order ID</th><th>Customer</th><th>Items</th><th>Total</th><th>Method</th><th>When</th></tr></thead>
        <tbody>
          ${orders.map(o=>`<tr>
            <td>${o.id}</td>
            <td>${escapeHtml(o.userName)}</td>
            <td>${o.items.map(it=>escapeHtml(it.name)+' ×'+(it.qty||1)).join('<br>')}</td>
            <td>₹${o.total}</td>
            <td>${o.method}</td>
            <td>${new Date(o.when).toLocaleString()}</td>
          </tr>`).join('')}
        </tbody>
      </table>
    `;
  } catch (error) {
    alert('Failed to load orders');
  }
}

/* ======= User flow: show list of restaurants to visit ======= */
async function showRestaurantSelection(){
  await loadRestaurantsFromAPI();
  // render list
  userContent.innerHTML = `<h3>Pick a restaurant to visit</h3><div id="rest-list-grid" class="list-rest"></div>`;
  const grid = document.getElementById('rest-list-grid');
  if(!restaurants.length){
    grid.innerHTML = `<div style="padding:14px;color:var(--muted)">No restaurants registered yet. Ask restaurants to register!</div>`;
    return;
  }
  grid.innerHTML = restaurants.map(r => {
    return `<div class="rest-card" data-rid="${r._id}">
      <img src="${r.logo || 'https://ui-avatars.com/api/?name=R&background=101827&color=fff'}" alt="logo">
      <div style="flex:1">
        <div style="font-weight:700">${escapeHtml(r.name)}</div>
        <div style="color:var(--muted);font-size:13px">${r.menu?.length||0} dishes · ${r.tables?.length||0} tables</div>
      </div>
      <div style="text-align:right">
        <button class="btn small" data-visit="${r._id}">Visit</button>
      </div>
    </div>`;
  }).join('');

  // attach click handlers
  grid.querySelectorAll('[data-visit]').forEach(btn=>{
    btn.addEventListener('click', (e)=>{
      const rid = btn.getAttribute('data-visit');
      visitRestaurant(rid);
    });
  });
}

/* Visit a restaurant as a user */
async function visitRestaurant(restaurantId){
  currentRestaurantId = restaurantId;
  await loadRestaurantsFromAPI();
  const rest = restaurants.find(r => r._id === restaurantId);
  if(!rest) return alert('Restaurant not found');

  // render restaurant view with tabs: menu, booking, payment, feedback
  userContent.innerHTML = `
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div style="display:flex;gap:10px;align-items:center">
        <img src="${rest.logo}" style="width:64px;height:64px;border-radius:8px;object-fit:cover">
        <div>
          <h3 style="margin:0">${escapeHtml(rest.name)}</h3>
          <div style="color:var(--muted);font-size:13px">${rest.menu?.length||0} dishes · ${rest.tables?.length||0} tables</div>
        </div>
      </div>
      <div style="text-align:right">
        <button class="btn small" id="back-to-list">Back</button>
      </div>
    </div>

    <div style="margin-top:12px" id="visit-tabs">
      <div style="display:flex;gap:8px;margin-bottom:12px">
        <button class="btn small" id="visit-menu-btn">Menu</button>
        <button class="btn small secondary" id="visit-book-btn">Book Table</button>
        <button class="btn small secondary" id="visit-pay-btn">Payment</button>
        <button class="btn small secondary" id="visit-feedback-btn">Feedback</button>
      </div>
      <div id="visit-area" style="background:#071a2b;padding:12px;border-radius:8px"></div>
    </div>
  `;

  document.getElementById('back-to-list').addEventListener('click', ()=> showRestaurantSelection());
  document.getElementById('visit-menu-btn').addEventListener('click', ()=> renderVisitMenu(rest));
  document.getElementById('visit-book-btn').addEventListener('click', ()=> renderVisitBooking(rest));
  document.getElementById('visit-pay-btn').addEventListener('click', ()=> renderVisitPayment(rest));
  document.getElementById('visit-feedback-btn').addEventListener('click', ()=> renderVisitFeedback(rest));

  // default show menu
  renderVisitMenu(rest);
}

/* Render visit menu (Zomato-style grid) */
function renderVisitMenu(rest){
  const area = document.getElementById('visit-area');
  area.innerHTML = '';
  if(!rest.menu || !rest.menu.length){ area.innerHTML = `<p style="color:var(--muted)">No dishes yet.</p>`; return; }

  // Create dish grid
  const grid = document.createElement('div');
  grid.className = 'dish-grid';
  rest.menu.forEach(m=>{
    const card = document.createElement('div');
    card.className = 'dish-card';
    const imgSrc = m.img || `https://source.unsplash.com/400x300/?food,${encodeURIComponent(m.name)}`;
    card.innerHTML = `
      <img src="${imgSrc}" alt="${escapeHtml(m.name)}">
      <div class="info">
        <div class="dish-name">${escapeHtml(m.name)}</div>
        <div class="dish-meta"><div>₹${m.price}</div><div class="order-count">${(m.orderCount||0)} orders</div></div>
        <div style="display:flex;gap:8px">
          <input type="number" min="1" value="1" class="qty-input" style="width:80px;border-radius:8px;padding:8px;background:transparent;border:1px solid rgba(255,255,255,0.06);color:#fff">
          <button class="btn add-btn small">Add</button>
        </div>
      </div>
    `;
    // Add handlers:
    const qtyInput = card.querySelector('.qty-input');
    const addBtn = card.querySelector('.add-btn');
    addBtn.addEventListener('click', ()=>{
      const qty = Math.max(1, Number(qtyInput.value) || 1);
      addToCartCustom(m._id, rest._id, qty);
    });
    grid.appendChild(card);
  });
  area.appendChild(grid);
  // back button
  const backWrap = document.createElement('div');
  backWrap.style.marginTop = '12px';
  backWrap.innerHTML = `<button class="back btn secondary" id="visit-back">Back to restaurants</button>`;
  area.appendChild(backWrap);
  document.getElementById('visit-back').addEventListener('click', ()=> showRestaurantSelection());
}

/* Add to cart simulated (stores in session variable) */
/* Cart items now include qty */
const sessionCart = {}; // key = restaurantId -> array of {id,name,price,qty}
async function addToCartCustom(dishId, restaurantId, qty){
  try {
    const rest = await apiRequest(`/restaurants/${restaurantId}`);
    const dish = rest.menu.find(m=>m._id===dishId);
    if(!dish) return alert('Dish not found');
    sessionCart[restaurantId] = sessionCart[restaurantId] || [];
    // if same dish already in cart, increase qty
    const existing = sessionCart[restaurantId].find(i=>i.id===dishId);
    if(existing){ existing.qty += qty; }
    else { sessionCart[restaurantId].push({id:dish._id, name:dish.name, price:dish.price, qty}); }
    alert(`Added ${qty} × ${dish.name} to cart`);
  } catch (error) {
    alert('Failed to add to cart');
  }
}

/* Render booking UI */
async function renderVisitBooking(rest){
  const area = document.getElementById('visit-area');
  try {
    const tables = await apiRequest(`/restaurants/${rest._id}/tables`);
    const availableTables = tables.filter(t=>!t.status || t.status === 'Available' || t.status === 'Free');
    if(!availableTables.length){
      area.innerHTML = `<p style="color:var(--muted)">No available tables at the moment.</p><div style="margin-top:12px"><button class="back btn secondary" id="visit-back2">Back</button></div>`;
      document.getElementById('visit-back2').addEventListener('click', ()=> showRestaurantSelection());
      return;
    }
    area.innerHTML = `
      <h4>Book a Table</h4>
      <label>Select table</label>
      <select id="select-table">${availableTables.map(t=>`<option value="${t.num}">Table ${t.num}</option>`).join('')}</select>
      <label>Start time</label><input type="time" id="book-start">
      <label>End time</label><input type="time" id="book-end">
      <label>Your name</label><input id="book-name" placeholder="Your name">
      <div style="display:flex;gap:8px;margin-top:10px">
        <button class="btn" id="confirm-book">Confirm Booking</button>
        <button class="btn secondary" id="booking-back">Back</button>
      </div>
    `;
    document.getElementById('booking-back').addEventListener('click', ()=> visitRestaurant(rest._id));
    document.getElementById('confirm-book').addEventListener('click', async ()=>{
      const tnum = document.getElementById('select-table').value;
      const start = document.getElementById('book-start').value;
      const end = document.getElementById('book-end').value;
      const uname = document.getElementById('book-name').value.trim();
      if(!tnum || !start || !end || !uname) return alert('Fill all fields');

      try {
        await apiRequest(`/restaurants/${rest._id}/bookings`, {
          method: 'POST',
          body: JSON.stringify({ tableNum: tnum, start, end, userName: uname })
        });
        alert(`✅ Table ${tnum} booked from ${start} to ${end}`);
        visitRestaurant(rest._id);
      } catch (error) {
        // error already alerted
      }
    });
  } catch (error) {
    area.innerHTML = `<p style="color:var(--muted)">Failed to load tables.</p>`;
  }
}

/* Render payment UI */
function renderVisitPayment(rest){
  const area = document.getElementById('visit-area');
  const cart = sessionCart[rest._id] || [];
  const total = cart.reduce((s,i)=>s + Number(i.price)*Number(i.qty||1),0);
  area.innerHTML = `
    <h4>Payment for ${escapeHtml(rest.name)}</h4>
    <div style="text-align:left">
      <strong>Cart:</strong>
      ${cart.length ? `<ul>${cart.map(c=>`<li>${escapeHtml(c.name)} — ₹${c.price} × ${c.qty} = ₹${Number(c.price)*Number(c.qty)}</li>`).join('')}</ul>` : '<p style="color:var(--muted)">Cart is empty</p>'}
      <p><strong>Total: ₹${total}</strong></p>
    </div>
    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:8px">
      <button class="btn" id="pay-upi">UPI (Simulate)</button>
      <button class="btn" id="pay-card">Card (Simulate)</button>
      <button class="btn secondary" id="pay-back">Back</button>
    </div>
  `;
  document.getElementById('pay-back').addEventListener('click', ()=> visitRestaurant(rest._id));
  document.getElementById('pay-upi').addEventListener('click', ()=> simulatePayment(rest, 'UPI', total));
  document.getElementById('pay-card').addEventListener('click', ()=> simulatePayment(rest, 'CARD', total));
}

/* payment simulation: record income at restaurant, create order record, update dish counts, and clear cart */
async function simulatePayment(rest, method, amount){
  if(amount <= 0) return alert('No amount to pay');
  const cart = sessionCart[rest._id] || [];
  if(!cart.length) return alert('Cart is empty');

  try {
    // Create order via API
    const orderData = {
      userName: currentAccount?.name || 'Guest',
      items: cart,
      total: amount,
      method
    };
    await apiRequest(`/restaurants/${rest._id}/orders`, {
      method: 'POST',
      body: JSON.stringify(orderData)
    });

    // clear cart for this restaurant
    sessionCart[rest._id] = [];
    alert(`✅ Payment of ₹${amount} recorded via ${method} — Order created`);
    visitRestaurant(rest._id);
  } catch (error) {
    // error already alerted
  }
}

/* Render visit feedback UI */
/* Render visit feedback UI (with star ratings) */
function renderVisitFeedback(rest){
  const area = document.getElementById('visit-area');
  area.innerHTML = `
    <h4>Give Feedback for ${escapeHtml(rest.name)}</h4>
    <label>Your name</label><input id="fb-name" placeholder="Your name">
    <label>Your feedback</label><textarea id="fb-text" placeholder="Write feedback..."></textarea>

    <label>Food Rating</label>
    <div id="food-rating" class="star-group" style="display:flex;gap:6px;cursor:pointer;margin-bottom:10px;">
      ${[1,2,3,4,5].map(i=>`<span data-val="${i}" style="font-size:24px;color:#444;">★</span>`).join('')}
    </div>

    <label>Service Rating</label>
    <div id="service-rating" class="star-group" style="display:flex;gap:6px;cursor:pointer;margin-bottom:10px;">
      ${[1,2,3,4,5].map(i=>`<span data-val="${i}" style="font-size:24px;color:#444;">★</span>`).join('')}
    </div>

    <div style="display:flex;gap:8px;margin-top:8px">
      <button class="btn" id="fb-send">Submit</button>
      <button class="btn secondary" id="fb-back">Back</button>
    </div>
  `;

  // Interactive stars
  function handleStars(containerId){
    const stars = document.querySelectorAll(`#${containerId} span`);
    let selected = 0;
    stars.forEach(star=>{
      star.addEventListener('click', ()=>{
        selected = Number(star.getAttribute('data-val'));
        stars.forEach(s=>{
          const val = Number(s.getAttribute('data-val'));
          s.style.color = val <= selected ? '#ffb703' : '#444';
        });
      });
    });
    return ()=>selected; // return getter for current rating
  }
  const getFoodRating = handleStars('food-rating');
  const getServiceRating = handleStars('service-rating');

  document.getElementById('fb-back').addEventListener('click', ()=> visitRestaurant(rest._id));
  document.getElementById('fb-send').addEventListener('click', async ()=>{
    const name = document.getElementById('fb-name').value.trim();
    const text = document.getElementById('fb-text').value.trim();
    const foodRating = getFoodRating();
    const serviceRating = getServiceRating();

    if(!name || !text) return alert('Enter name and feedback');
    if(foodRating === 0 || serviceRating === 0) return alert('Please rate both food and service.');

    try {
      await apiRequest(`/restaurants/${rest._id}/feedback`, {
        method: 'POST',
        body: JSON.stringify({ userName: name, text, foodRating, serviceRating })
      });
      alert('Thanks for your feedback!');
      visitRestaurant(rest._id);
    } catch (error) {
      // error already alerted
    }
  });
}




/* ======= helpers ======= */
function escapeHtml(s){
  if(!s) return '';
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

/* ======= initial sync ======= */
/* load data into memory at startup */
(async () => {
  await loadRestaurantsFromAPI();
})();

/* Optional demo data: uncomment to seed a sample restaurant for testing */
/*
if(!restaurants.length){
  const rid = uid('rest');
  restaurants.push({
    id: rid,
    name: 'Demo Diner',
    email: 'demo@example.com',
    logo: `https://ui-avatars.com/api/?name=Demo+Diner&background=101827&color=fff`,
    menu: [
      {id: uid('dish'), name: 'Masala Dosa', price: 120, img:'https://source.unsplash.com/400x300/?dosa', orderCount: 2},
      {id: uid('dish'), name: 'Paneer Butter Masala', price: 220, img:'https://source.unsplash.com/400x300/?paneer', orderCount: 5},
    ],
    tables: [{num:'1',status:'Available'},{num:'2',status:'Available'}],
    bookings: [],
    incomes: [],
    feedback: [],
    orders: []
  });
  saveRestaurants(restaurants);
}
*/

</script>
</body>
</html>